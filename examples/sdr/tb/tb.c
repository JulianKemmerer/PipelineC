// Test bench
#include "arrays.h"
#include "intN_t.h"
#include "uintN_t.h"
#pragma PART "xc7a100tcsg324-1"

// IQ samples generated by python script
#include "samples.h"

// Functions to test
#include "../fm_radio.h"

// The test bench sending samples into a module and printing output sampples
#pragma MAIN tb
void tb()
{
  static uint32_t cycle_counter;
  static int16_t i_samples[I_SAMPLES_SIZE] = I_SAMPLES;
  static int16_t q_samples[Q_SAMPLES_SIZE] = Q_SAMPLES;

  // Prepare input sample into FIR
  fir_decim_in_data_stream_type(decim_5x) i_input;
  i_input.data = i_samples[0];
  i_input.valid = 1;
  fir_decim_in_data_stream_type(decim_5x) q_input;
  q_input.data = q_samples[0];
  q_input.valid = 1;

  // Do one clock cycle, input valid and get output
  fir_decim_out_data_stream_type(decim_5x) i_output;
  i_output = decim_5x(i_input);
  fir_decim_out_data_stream_type(decim_5x) q_output;
  q_output = decim_5x(q_input);

  // Print valid output samples
  if(i_output.valid&q_output.valid){
    printf("Cycle %d,Sample IQ =,%d,%d\n", cycle_counter, i_output.data, q_output.data);
  }

  // Prepare for next sample
  ARRAY_SHIFT_DOWN(i_samples, I_SAMPLES_SIZE, 1)
  ARRAY_SHIFT_DOWN(q_samples, Q_SAMPLES_SIZE, 1)
  cycle_counter+=1;
}