#include "../../../sccb/software/sccb.h"
#include "../../../clock/software/clock.h"

// Select the device using first 8b written to device
//   Examples and app notes show D[7:0] = 0x60
//   where D[0] is RW bit, write=0
//   D[7:1] = 0x30 selects the device
#define OV2640_SCCB_WRITE_ID 0x60 // From app notes
#define OV2640_SCCB_ID (OV2640_SCCB_WRITE_ID>>1) // drop RW bit
#define ov2640_sccb_write(addr, write_data) sccb_write(OV2640_SCCB_ID, addr, write_data)
#define ov2640_sccb_read(addr) sccb_read(OV2640_SCCB_ID, addr)


void ov2640_soft_reset(){
  ov2640_sccb_write(0xff, 0x01);
  ov2640_sccb_write(0x12, 0x80);
  wait_ms(3);
}

void ov2640_cam_init(){
  // Wait for POR
  wait_ms(3);

  // Issue soft reset (waits too)
  ov2640_soft_reset();

  // Do init reg writes
  // 13.2 RGB 565 Reference Setting
  // MCLK 24Mhz, SVGA RGB565 output 25fps
ov2640_sccb_write(0xff, 0x00);
ov2640_sccb_write(0x2c, 0xff);
ov2640_sccb_write(0x2e, 0xdf);
ov2640_sccb_write(0xff, 0x01);
ov2640_sccb_write(0x3c, 0x32);
//
ov2640_sccb_write(0x11, 0x00);
ov2640_sccb_write(0x09, 0x02);
ov2640_sccb_write(0x04, 0x28);
ov2640_sccb_write(0x13, 0xe5);
ov2640_sccb_write(0x14, 0x48);
ov2640_sccb_write(0x2c, 0x0c);
ov2640_sccb_write(0x33, 0x78);
ov2640_sccb_write(0x3a, 0x33);
ov2640_sccb_write(0x3b, 0xfB);
//
ov2640_sccb_write(0x3e, 0x00);
ov2640_sccb_write(0x43, 0x11);
ov2640_sccb_write(0x16, 0x10);
//
ov2640_sccb_write(0x39, 0x92);
//
ov2640_sccb_write(0x35, 0xda);
ov2640_sccb_write(0x22, 0x1a);
ov2640_sccb_write(0x37, 0xc3);
ov2640_sccb_write(0x23, 0x00);
ov2640_sccb_write(0x34, 0xc0);
ov2640_sccb_write(0x36, 0x1a);
ov2640_sccb_write(0x06, 0x88);
ov2640_sccb_write(0x07, 0xc0);
ov2640_sccb_write(0x0d, 0x87);
ov2640_sccb_write(0x0e, 0x41);
ov2640_sccb_write(0x4c, 0x00);
ov2640_sccb_write(0x48, 0x00);
ov2640_sccb_write(0x5B, 0x00);
ov2640_sccb_write(0x42, 0x03);
//
ov2640_sccb_write(0x4a, 0x81);
ov2640_sccb_write(0x21, 0x99);
//
ov2640_sccb_write(0x24, 0x40);
ov2640_sccb_write(0x25, 0x38);
ov2640_sccb_write(0x26, 0x82);
ov2640_sccb_write(0x5c, 0x00);
ov2640_sccb_write(0x63, 0x00);
ov2640_sccb_write(0x46, 0x22);
ov2640_sccb_write(0x0c, 0x3c);
//
ov2640_sccb_write(0x61, 0x70);
ov2640_sccb_write(0x62, 0x80);
ov2640_sccb_write(0x7c, 0x05);
//
ov2640_sccb_write(0x20, 0x80);
ov2640_sccb_write(0x28, 0x30);
ov2640_sccb_write(0x6c, 0x00);
ov2640_sccb_write(0x6d, 0x80);
ov2640_sccb_write(0x6e, 0x00);
ov2640_sccb_write(0x70, 0x02);
ov2640_sccb_write(0x71, 0x94);
ov2640_sccb_write(0x73, 0xc1);
//
ov2640_sccb_write(0x12, 0x40); // data=0x42 enables colors bars
ov2640_sccb_write(0x17, 0x11);
ov2640_sccb_write(0x18, 0x43);
ov2640_sccb_write(0x19, 0x00);
ov2640_sccb_write(0x1a, 0x4b);
ov2640_sccb_write(0x32, 0x09);
ov2640_sccb_write(0x37, 0xc0);
ov2640_sccb_write(0x4f, 0xca);
ov2640_sccb_write(0x50, 0xa8);
ov2640_sccb_write(0x5a, 0x23);
ov2640_sccb_write(0x6d, 0x00);
ov2640_sccb_write(0x3d, 0x38);
//
ov2640_sccb_write(0xff, 0x00);
ov2640_sccb_write(0xe5, 0x7f);
ov2640_sccb_write(0xf9, 0xc0);
ov2640_sccb_write(0x41, 0x24);
ov2640_sccb_write(0xe0, 0x14);
ov2640_sccb_write(0x76, 0xff);
ov2640_sccb_write(0x33, 0xa0);
ov2640_sccb_write(0x42, 0x20);
ov2640_sccb_write(0x43, 0x18);
ov2640_sccb_write(0x4c, 0x00);
ov2640_sccb_write(0x87, 0xd5);
ov2640_sccb_write(0x88, 0x3f);
ov2640_sccb_write(0xd7, 0x03);
ov2640_sccb_write(0xd9, 0x10);
ov2640_sccb_write(0xd3, 0x82);
//
ov2640_sccb_write(0xc8, 0x08);
ov2640_sccb_write(0xc9, 0x80);
//
ov2640_sccb_write(0x7c, 0x00);
ov2640_sccb_write(0x7d, 0x00);
ov2640_sccb_write(0x7c, 0x03);
ov2640_sccb_write(0x7d, 0x48);
ov2640_sccb_write(0x7d, 0x48);
ov2640_sccb_write(0x7c, 0x08);
ov2640_sccb_write(0x7d, 0x20);
ov2640_sccb_write(0x7d, 0x10);
ov2640_sccb_write(0x7d, 0x0e);
//
ov2640_sccb_write(0x90, 0x00);
ov2640_sccb_write(0x91, 0x0e);
ov2640_sccb_write(0x91, 0x1a);
ov2640_sccb_write(0x91, 0x31);
ov2640_sccb_write(0x91, 0x5a);
ov2640_sccb_write(0x91, 0x69);
ov2640_sccb_write(0x91, 0x75);
ov2640_sccb_write(0x91, 0x7e);
ov2640_sccb_write(0x91, 0x88);
ov2640_sccb_write(0x91, 0x8f);
ov2640_sccb_write(0x91, 0x96);
ov2640_sccb_write(0x91, 0xa3);
ov2640_sccb_write(0x91, 0xaf);
ov2640_sccb_write(0x91, 0xc4);
ov2640_sccb_write(0x91, 0xd7);
ov2640_sccb_write(0x91, 0xe8);
ov2640_sccb_write(0x91, 0x20);
//
ov2640_sccb_write(0x92, 0x00);
ov2640_sccb_write(0x93, 0x06);
ov2640_sccb_write(0x93, 0xe3);
ov2640_sccb_write(0x93, 0x05);
ov2640_sccb_write(0x93, 0x05);
ov2640_sccb_write(0x93, 0x00);
ov2640_sccb_write(0x93, 0x04);
ov2640_sccb_write(0x93, 0x00);
ov2640_sccb_write(0x93, 0x00);
ov2640_sccb_write(0x93, 0x00);
ov2640_sccb_write(0x93, 0x00);
ov2640_sccb_write(0x93, 0x00);
ov2640_sccb_write(0x93, 0x00);
ov2640_sccb_write(0x93, 0x00);
//
ov2640_sccb_write(0x96, 0x00);
ov2640_sccb_write(0x97, 0x08);
ov2640_sccb_write(0x97, 0x19);
ov2640_sccb_write(0x97, 0x02);
ov2640_sccb_write(0x97, 0x0c);
ov2640_sccb_write(0x97, 0x24);
ov2640_sccb_write(0x97, 0x30);
ov2640_sccb_write(0x97, 0x28);
ov2640_sccb_write(0x97, 0x26);
ov2640_sccb_write(0x97, 0x02);
ov2640_sccb_write(0x97, 0x98);
ov2640_sccb_write(0x97, 0x80);
ov2640_sccb_write(0x97, 0x00);
ov2640_sccb_write(0x97, 0x00);
//
ov2640_sccb_write(0xc3, 0xed);
ov2640_sccb_write(0xa4, 0x00);
ov2640_sccb_write(0xa8, 0x00);
ov2640_sccb_write(0xc5, 0x11);
ov2640_sccb_write(0xc6, 0x51);
ov2640_sccb_write(0xbf, 0x80);
ov2640_sccb_write(0xc7, 0x10);
ov2640_sccb_write(0xb6, 0x66);
ov2640_sccb_write(0xb8, 0xA5);
ov2640_sccb_write(0xb7, 0x64);
ov2640_sccb_write(0xb9, 0x7C);
ov2640_sccb_write(0xb3, 0xaf);
ov2640_sccb_write(0xb4, 0x97);
ov2640_sccb_write(0xb5, 0xFF);
ov2640_sccb_write(0xb0, 0xC5);
ov2640_sccb_write(0xb1, 0x94);
ov2640_sccb_write(0xb2, 0x0f);
ov2640_sccb_write(0xc4, 0x5c);
//
ov2640_sccb_write(0xc0, 0x64);
ov2640_sccb_write(0xc1, 0x4B);
ov2640_sccb_write(0x8c, 0x00);
ov2640_sccb_write(0x86, 0x3D);
ov2640_sccb_write(0x50, 0x00);
ov2640_sccb_write(0x51, 0xC8);
ov2640_sccb_write(0x52, 0x96);
ov2640_sccb_write(0x53, 0x00);
ov2640_sccb_write(0x54, 0x00);
ov2640_sccb_write(0x55, 0x00);
ov2640_sccb_write(0x5a, 0xC8);
ov2640_sccb_write(0x5b, 0x96);
ov2640_sccb_write(0x5c, 0x00);
ov2640_sccb_write(0xd3, 0x82);
//
ov2640_sccb_write(0xc3, 0xed);
ov2640_sccb_write(0x7f, 0x00);
//
ov2640_sccb_write(0xda, 0x08);
//
ov2640_sccb_write(0xe5, 0x1f);
ov2640_sccb_write(0xe1, 0x67);
ov2640_sccb_write(0xe0, 0x00);
ov2640_sccb_write(0xdd, 0x7f);
ov2640_sccb_write(0x05, 0x00);

  // Signal init done to enable decoder output stream
  mm_regs->cam_init_done = 1;

  // Wait for frame size valid from decoder to ensure frame lock
  while(!mm_regs->cam_frame_size_valid){}
}